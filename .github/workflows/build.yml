name: Check Dawn Branches and Build Latest

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DAWN_REPO: 'https://dawn.googlesource.com/dawn'
  
jobs:
  check-new-branches:
    runs-on: ubuntu-latest
    outputs:
      latest-branch: ${{ steps.check.outputs.latest-branch }}
      latest-version: ${{ steps.check.outputs.latest-version }}
      has-new-branch: ${{ steps.check.outputs.has-new-branch }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: Check for new Dawn branches and find latest
      id: check
      run: |
        # è·å– Dawn ä»“åº“çš„æ‰€æœ‰åˆ†æ”¯
        echo "Fetching Dawn repository branches..."
        git ls-remote --heads $DAWN_REPO | grep 'refs/heads/chromium/' > current_branches.txt
        
        # åˆ›å»º previous_branches.txt å¦‚æœä¸å­˜åœ¨
        if [ ! -f previous_branches.txt ]; then
          touch previous_branches.txt
        fi
        
        # æ¯”è¾ƒæ‰¾å‡ºæ–°åˆ†æ”¯
        new_branches=$(comm -13 <(sort previous_branches.txt) <(sort current_branches.txt))
        
        if [ -n "$new_branches" ]; then
          echo "New branches found:"
          echo "$new_branches"
          
          # ä»æ–°åˆ†æ”¯ä¸­æå–ç‰ˆæœ¬å·å¹¶æ‰¾åˆ°æœ€å¤§çš„
          max_version=0
          latest_branch=""
          
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              branch_name=$(echo "$line" | awk '{print $2}' | sed 's|refs/heads/||')
              version=$(echo "$branch_name" | sed 's|chromium/||')
              
              echo "Found branch: $branch_name with version: $version"
              
              # æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆæ•°å­—æ¯”è¾ƒï¼‰
              if [ "$version" -gt "$max_version" ]; then
                max_version=$version
                latest_branch=$branch_name
              fi
            fi
          done <<< "$new_branches"
          
          if [ -n "$latest_branch" ]; then
            echo "Latest branch to build: $latest_branch (version: $max_version)"
            echo "has-new-branch=true" >> $GITHUB_OUTPUT
            echo "latest-branch=$latest_branch" >> $GITHUB_OUTPUT
            echo "latest-version=$max_version" >> $GITHUB_OUTPUT
          else
            echo "No valid branches found"
            echo "has-new-branch=false" >> $GITHUB_OUTPUT
          fi
          
          # æ›´æ–°è®°å½•æ–‡ä»¶
          cp current_branches.txt previous_branches.txt
          git add previous_branches.txt
          git commit -m "Update tracked branches - Latest: $latest_branch" || true
          git push || true
        else
          echo "No new branches found"
          echo "has-new-branch=false" >> $GITHUB_OUTPUT
          echo "latest-branch=" >> $GITHUB_OUTPUT
          echo "latest-version=" >> $GITHUB_OUTPUT
        fi

  build-dawn:
    needs: check-new-branches
    if: needs.check-new-branches.outputs.has-new-branch == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          python3 \
          ninja-build \
          python3-pip \
          libx11-dev \
          libxi-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          mesa-common-dev \
          libx11-xcb-dev \
          pkg-config \
          nodejs \
          npm

    - name: Set environment variables
      run: |
        echo "BRANCH_NAME=${{ needs.check-new-branches.outputs.latest-branch }}" >> $GITHUB_ENV
        echo "VERSION=${{ needs.check-new-branches.outputs.latest-version }}" >> $GITHUB_ENV

    - name: Clone Dawn repository
      run: |
        echo "Building Dawn from branch: ${{ env.BRANCH_NAME }}"
        git clone --depth 1 --branch ${{ env.BRANCH_NAME }} $DAWN_REPO dawn-source

    - name: Configure Dawn build with CMake
      run: |
        cd dawn-source
        
        echo "Configuring Dawn build with automatic dependency fetching..."
        cmake -B out/Release \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=../dawn-install \
          -DDAWN_FETCH_DEPENDENCIES=ON \
          -DDAWN_ENABLE_INSTALL=ON \
          -G Ninja

    - name: Build Dawn
      run: |
        cd dawn-source
        echo "Building Dawn for Chromium version ${{ env.VERSION }}..."
        echo "This may take a while as dependencies are being fetched automatically..."
        cmake --build out/Release --parallel $(nproc)

    - name: Install Dawn
      run: |
        cd dawn-source
        echo "Installing Dawn to staging directory..."
        cmake --install out/Release

    - name: Package build artifacts
      run: |
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "Branch: ${{ env.BRANCH_NAME }}" > dawn-install/BUILD_INFO.txt
        echo "Chromium Version: ${{ env.VERSION }}" >> dawn-install/BUILD_INFO.txt
        echo "Build Date: $(date -u)" >> dawn-install/BUILD_INFO.txt
        echo "Build ID: ${{ github.run_id }}" >> dawn-install/BUILD_INFO.txt
        echo "CMake Configuration: Release with shared libraries" >> dawn-install/BUILD_INFO.txt
        
        # æ˜¾ç¤ºå®‰è£…å†…å®¹
        echo "Installed Dawn contents:"
        find dawn-install -type f | head -20
        echo "..."
        echo "Total files: $(find dawn-install -type f | wc -l)"
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czf dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz dawn-install/
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        sha256sum dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz > dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
        
        # æ˜¾ç¤ºåŒ…å¤§å°
        ls -lh dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.BRANCH_NAME }}
        name: "Dawn Build - ${{ env.BRANCH_NAME }}"
        body: |
          ğŸš€ **æœ€æ–° Dawn è‡ªåŠ¨æ„å»º (å…±äº«åº“ç‰ˆæœ¬)**
          
          è¿™æ˜¯ä» Google Dawn ä»“åº“è‡ªåŠ¨æ„å»ºçš„æœ€æ–°ç‰ˆæœ¬ï¼ŒåŒ…å«å®Œæ•´çš„å…±äº«åº“å’Œå¼€å‘æ–‡ä»¶ã€‚
          
          **æ„å»ºä¿¡æ¯:**
          - åˆ†æ”¯: `${{ env.BRANCH_NAME }}`
          - Chromium ç‰ˆæœ¬: `${{ env.VERSION }}`
          - æ„å»ºæ—¥æœŸ: $(date -u)
          - å¹³å°: Linux x64
          - åº“ç±»å‹: **å…±äº«åº“ (Shared Libraries)**
          
          **æ„å»ºç‰¹æ€§:**
          - âœ… `DAWN_FETCH_DEPENDENCIES=ON` - è‡ªåŠ¨è·å–æ‰€æœ‰ä¾èµ–
          - âœ… `DAWN_ENABLE_INSTALL=ON` - å®Œæ•´å®‰è£…å¸ƒå±€
          - âœ… `BUILD_SHARED_LIBS=ON` - æ„å»ºå…±äº«åº“
          - âœ… Release ä¼˜åŒ–æ„å»º
          
          **åŒ…å«å†…å®¹:**
          - Dawn WebGPU å®ç°åº“ (libdawn_*)
          - Dawn å¤´æ–‡ä»¶å’Œå¼€å‘æ–‡ä»¶
          - CMake é…ç½®æ–‡ä»¶
          - å®Œæ•´çš„ pkg-config æ–‡ä»¶
          
          **ä½¿ç”¨æ–¹æ³•:**
          ```bash
          # ä¸‹è½½å¹¶éªŒè¯
          wget https://github.com/Ariaszzzhc/dawn-builder/releases/download/${{ env.BRANCH_NAME }}/dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          wget https://github.com/Ariaszzzhc/dawn-builder/releases/download/${{ env.BRANCH_NAME }}/dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
          sha256sum -c dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
          
          # è§£å‹å¹¶å®‰è£…
          tar -xzf dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          sudo cp -r dawn-install/* /usr/local/
          
          # æˆ–è€…è®¾ç½®ç¯å¢ƒå˜é‡ä½¿ç”¨
          export DAWN_ROOT=$(pwd)/dawn-install
          export PKG_CONFIG_PATH=$DAWN_ROOT/lib/pkgconfig:$PKG_CONFIG_PATH
          export LD_LIBRARY_PATH=$DAWN_ROOT/lib:$LD_LIBRARY_PATH
          ```
          
          **CMake é›†æˆ:**
          ```cmake
          find_package(dawn REQUIRED)
          target_link_libraries(your_target dawn::dawn)
          ```
        files: |
          dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [check-new-branches, build-dawn]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup old releases (keep latest 10)
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
