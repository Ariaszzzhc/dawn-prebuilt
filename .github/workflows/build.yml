name: Check Dawn Branches and Build Latest

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  DAWN_REPO: 'https://dawn.googlesource.com/dawn'
  
jobs:
  check-new-branches:
    runs-on: ubuntu-latest
    outputs:
      latest-branch: ${{ steps.check.outputs.latest-branch }}
      latest-version: ${{ steps.check.outputs.latest-version }}
      has-new-branch: ${{ steps.check.outputs.has-new-branch }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Git
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
    
    - name: Check for new Dawn branches and find latest
      id: check
      run: |
        # è·å– Dawn ä»“åº“çš„æ‰€æœ‰åˆ†æ”¯
        echo "Fetching Dawn repository branches..."
        git ls-remote --heads $DAWN_REPO | grep 'refs/heads/chromium/' > current_branches.txt
        
        # åˆ›å»º previous_branches.txt å¦‚æœä¸å­˜åœ¨
        if [ ! -f previous_branches.txt ]; then
          touch previous_branches.txt
        fi
        
        # æ¯”è¾ƒæ‰¾å‡ºæ–°åˆ†æ”¯
        new_branches=$(comm -13 <(sort previous_branches.txt) <(sort current_branches.txt))
        
        if [ -n "$new_branches" ]; then
          echo "New branches found:"
          echo "$new_branches"
          
          # ä»æ–°åˆ†æ”¯ä¸­æå–ç‰ˆæœ¬å·å¹¶æ‰¾åˆ°æœ€å¤§çš„
          max_version=0
          latest_branch=""
          
          while IFS= read -r line; do
            if [ -n "$line" ]; then
              branch_name=$(echo "$line" | awk '{print $2}' | sed 's|refs/heads/||')
              version=$(echo "$branch_name" | sed 's|chromium/||')
              
              echo "Found branch: $branch_name with version: $version"
              
              # æ¯”è¾ƒç‰ˆæœ¬å·ï¼ˆæ•°å­—æ¯”è¾ƒï¼‰
              if [ "$version" -gt "$max_version" ]; then
                max_version=$version
                latest_branch=$branch_name
              fi
            fi
          done <<< "$new_branches"
          
          if [ -n "$latest_branch" ]; then
            echo "Latest branch to build: $latest_branch (version: $max_version)"
            echo "has-new-branch=true" >> $GITHUB_OUTPUT
            echo "latest-branch=$latest_branch" >> $GITHUB_OUTPUT
            echo "latest-version=$max_version" >> $GITHUB_OUTPUT
          else
            echo "No valid branches found"
            echo "has-new-branch=false" >> $GITHUB_OUTPUT
          fi
          
          # æ›´æ–°è®°å½•æ–‡ä»¶
          cp current_branches.txt previous_branches.txt
          git add previous_branches.txt
          git commit -m "Update tracked branches - Latest: $latest_branch" || true
          git push || true
        else
          echo "No new branches found"
          echo "has-new-branch=false" >> $GITHUB_OUTPUT
          echo "latest-branch=" >> $GITHUB_OUTPUT
          echo "latest-version=" >> $GITHUB_OUTPUT
        fi

  build-dawn:
    needs: check-new-branches
    if: needs.check-new-branches.outputs.has-new-branch == 'true'
    runs-on: ubuntu-latest
    
    steps:
    - name: Setup dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          git \
          python3 \
          python3-pip \
          ninja-build \
          pkg-config \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libgl1-mesa-dev

    - name: Set environment variables
      run: |
        echo "BRANCH_NAME=${{ needs.check-new-branches.outputs.latest-branch }}" >> $GITHUB_ENV
        echo "VERSION=${{ needs.check-new-branches.outputs.latest-version }}" >> $GITHUB_ENV

    - name: Clone Dawn repository
      run: |
        echo "Building Dawn from branch: ${{ env.BRANCH_NAME }}"
        git clone --depth 1 --branch ${{ env.BRANCH_NAME }} $DAWN_REPO dawn-source

    - name: Setup build environment
      run: |
        cd dawn-source
        
        # åˆå§‹åŒ– gclientï¼ˆå¦‚æœéœ€è¦ï¼‰
        if [ -f .gclient ]; then
          gclient sync
        fi
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p out/Release

    - name: Configure build
      run: |
        cd dawn-source
        
        # ä½¿ç”¨ CMake é…ç½®æ„å»º
        cmake -B out/Release \
          -DCMAKE_BUILD_TYPE=Release \
          -DDAWN_BUILD_SAMPLES=OFF \
          -DDAWN_BUILD_TESTS=OFF \
          -DTINT_BUILD_TESTS=OFF \
          -G Ninja

    - name: Build Dawn
      run: |
        cd dawn-source
        echo "Building Dawn for Chromium version ${{ env.VERSION }}..."
        cmake --build out/Release --parallel $(nproc)

    - name: Package build artifacts
      run: |
        cd dawn-source
        
        # åˆ›å»ºå‘å¸ƒåŒ…ç›®å½•
        mkdir -p ../dawn-release
        
        # å¤åˆ¶æ„å»ºäº§ç‰©
        cp -r out/Release/lib* ../dawn-release/ 2>/dev/null || true
        cp -r out/Release/bin* ../dawn-release/ 2>/dev/null || true
        cp -r include ../dawn-release/ 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "Branch: ${{ env.BRANCH_NAME }}" > ../dawn-release/BUILD_INFO.txt
        echo "Chromium Version: ${{ env.VERSION }}" >> ../dawn-release/BUILD_INFO.txt
        echo "Build Date: $(date -u)" >> ../dawn-release/BUILD_INFO.txt
        echo "Build ID: ${{ github.run_id }}" >> ../dawn-release/BUILD_INFO.txt
        
        # åˆ›å»ºå‹ç¼©åŒ…
        cd ..
        tar -czf dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz dawn-release/
        
        # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
        sha256sum dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz > dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.BRANCH_NAME }}
        name: "Dawn Build - ${{ env.BRANCH_NAME }}"
        body: |
          ğŸš€ **æœ€æ–° Dawn è‡ªåŠ¨æ„å»º**
          
          è¿™æ˜¯ä» Google Dawn ä»“åº“è‡ªåŠ¨æ„å»ºçš„æœ€æ–°ç‰ˆæœ¬ã€‚
          
          **æ„å»ºä¿¡æ¯:**
          - åˆ†æ”¯: `${{ env.BRANCH_NAME }}`
          - Chromium ç‰ˆæœ¬: `${{ env.VERSION }}`
          - æ„å»ºæ—¥æœŸ: ${{ github.run_number }}
          - å¹³å°: Linux x64
          
          **è¯´æ˜:**
          - æ¯å¤©è‡ªåŠ¨æ£€æŸ¥æ–°åˆ†æ”¯ï¼Œåªæ„å»º**æœ€æ–°ç‰ˆæœ¬å·**çš„åˆ†æ”¯
          - é¿å…é‡å¤æ„å»ºï¼Œç¡®ä¿ä½ è·å¾—çš„å§‹ç»ˆæ˜¯æœ€æ–°çš„ Dawn ç‰ˆæœ¬
          
          **æ–‡ä»¶è¯´æ˜:**
          - `dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz` - Dawn åº“æ–‡ä»¶å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
          - `dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256` - SHA256 æ ¡éªŒå’Œ
          - `BUILD_INFO.txt` - è¯¦ç»†æ„å»ºä¿¡æ¯ï¼ˆåŒ…å«åœ¨å‹ç¼©åŒ…å†…ï¼‰
          
          **ä½¿ç”¨æ–¹æ³•:**
          ```bash
          # ä¸‹è½½å¹¶éªŒè¯
          wget https://github.com/${{ github.repository }}/releases/download/${{ env.BRANCH_NAME }}/dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          wget https://github.com/${{ github.repository }}/releases/download/${{ env.BRANCH_NAME }}/dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
          sha256sum -c dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
          
          # è§£å‹ä½¿ç”¨
          tar -xzf dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          ```
        files: |
          dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz
          dawn-${{ env.BRANCH_NAME }}-linux-x64.tar.gz.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [check-new-branches, build-dawn]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup old releases (keep latest 10)
      uses: dev-drprasad/delete-older-releases@v0.3.2
      with:
        keep_latest: 10
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

